---
layout: post
title: Day10-拆分 Model
tags: [Mongoose,Schema,MongoDB,JavaScript]
author: EmptyWu
date: 2022-04-22 10:01:05
category: 資料庫
description: 使用到的資料可能不只有一個 Collection，像是最後會完成的貼文動態牆，會使用到貼文及使用者等等資料，所有資料的 Model、Schema 都集中在 server.js，可能會造成維護、管理不易
---

## 前言
使用到的資料可能不只有一個 Collection，像是最後會完成的貼文動態牆，會使用到貼文及使用者等等資料，
所有資料的 Model、Schema 都集中在 server.js，可能會造成維護、管理不易
因此可以嘗試將不同資料的 Model 拆分出來，再引入至 server.js 做使用

<!--more-->

### 拆分步驟
- 在專案中建立 models 資料夾
- 分別依 Collection 建立檔案，如：posts.js、users.js…等等
- 因 Schema、Model 建立都需要 Mongoose 套件，因此需記得分別在 posts.js、users.js 引入 Mongoose 套件將 Schema、Model 拆出來
```javascript
const postSchema = new mongoose.Schema(
  ...
);
const Post = mongoose.model('Post', postSchema);

module.exports = Post;
```
- 接著引入 models 資料夾中的 Model 到 server.js，即可直接針對 Model 操作新增、查詢、修改、刪除資料
註：引入 Model 時通常變數會使用大寫開頭，例如 Post、User，即可使用 Post.create(...) 等方式直接針對 Post 操作


## 練習

嘗試將下列資訊進行拆解
```javascript
const http = require("http");
const mongoose = require('mongoose');
mongoose.connect('mongodb://localhost:27017/test')
.then(()=>{
  console.log('資料庫連線成功')
})
.catch((error)=>{
  console.log(error);
});
const drinkSchema = new mongoose.Schema({  
  product: {
    type: String,
    required: [true, '產品名稱未填寫']
  },
  price: {
    type: Number,
    required: [true, '價錢未填寫'] 
  },
  ice: {
    type: String,
    default: "正常冰"
  },
  sugar: {
    type: String,
    default: "全糖"
  },
  toppings: [{
      type: String,
      enum: ["珍珠", "椰果", "粉條"],
      default: '',
    }],
  createdAt: {
    type: Date, 
    default: Date.now,
    select: false
  },

 },{
  versionKey: false,
});

const Drink = mongoose.model('Drink', drinkSchema);

/* 可先執行這段新增資料到 drinks collection */
// Drink.create({
//   product: '鮮奶茶',
//   price: 56,
//   sugar: '半糖'
// },{
//   product: '烏龍鮮奶茶',
//   price: 60,
//   sugar: '微糖'
// },{
//   product: '四季春茶',
//   price: 30,
//   sugar: '少糖',
//   ice: "去冰"
// })


/*
可先在此填寫答案，並使用 GET 測試是否更新、刪除成功
...









*/
  
const requestListener = async (req,res)=>{
  let body = "";
  req.on('data',chunk=>{
      body+=chunk;
  })
  const headers = {
      'Access-Control-Allow-Headers': 'Content-Type, Authorization, Content-Length, X-Requested-With',
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'PATCH, POST, GET,OPTIONS,DELETE',
      'Content-Type': 'application/json'
  }
  if(req.url=="/drinks" && req.method=="GET"){
      const drinks = await Drink.find();
      res.writeHead(200,headers);
      res.write(JSON.stringify({
          "status":"success",
          drinks
      }))
      res.end()
  }else if(req.url=="/drinks" && req.method=="POST"){
      req.on('end', async()=>{
          try{
              const data = JSON.parse(body);
              const newDrink = await Drink.create(
                  {
                    product: data.product,
                    price: data.price,
                    toppings: data.toppings,
                  }
              )
              res.writeHead(200,headers);
              res.write(JSON.stringify({
                  "status":"success",
                  drinks: newDrink
              }))
              res.end()
          }catch(error){
              res.writeHead(400,headers);
              res.write(JSON.stringify({
                  "status": "false",
                  "message":"欄位沒有正確，或沒有此 ID",
                  "error": error
              }))
              res.end()
          }
      })
  }
  else if(req.url=="/drinks" && req.method=="DELETE"){
      await Drink.deleteMany({});
      res.writeHead(200,headers);
      res.write(JSON.stringify({
          "status":"success",
          drinks:[]
      }))
      res.end();
  }
  else if(req.method == "OPTIONS"){
      res.writeHead(200,headers);
      res.end();
  }else{
      res.writeHead(404,headers);
      res.write(JSON.stringify({
          "status": "false",
          "message": "無此網站路由"
      }));
      res.end();
  }
}

const server = http.createServer(requestListener);
server.listen(3005);
```

- models 資料夾 - posts.js
```javascript
const mongoose = require('mongoose');
const drinkSchema = new mongoose.Schema({  
  user:{
        type: String,
        required: [true, 'user未填寫'],
    },
    content: {
        type: String,
        required: [true, 'content未填寫'],
    },
    createdAt: {
        type: Date,
        default: Date.now,
        select: false,
    },
 },{
  versionKey: false,
});

const Post = mongoose.model('Post', postSchema);
module.exports = Post;
```
- server.js
```javascript
const Post  = require('./models/posts');
```

以上見解，如有錯誤地方還請留言告知，感謝。